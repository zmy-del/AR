<html>
<!-- import aframe and then ar.js with image tracking / location based features -->
<script src="aframe-master.min.js"></script>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>

<!-- style for the loader -->
<style>
  .arjs-loader {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .arjs-loader div {
    text-align: center;
    font-size: 1.25em;
    color: white;
  }
  
  .debug-info {
    position: fixed;
    bottom: 10px;
    left: 10px;
    color: white;
    background-color: rgba(0,0,0,0.7);
    padding: 10px;
    font-size: 14px;
    z-index: 999;
  }
  
  .error-message {
    color: red;
    font-weight: bold;
  }

  .manual-start-btn {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    padding: 15px 30px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 18px;
    cursor: pointer;
    z-index: 10000;
    display: none;
  }
</style>
<script src="aframe-ar-nft.js"></script>

<body style="margin : 0px; overflow: hidden;">
  <!-- minimal loader shown until image descriptors are loaded. Loading may take a while according to the device computational power -->
  <div class="arjs-loader">
    <div>æ­£åœ¨åŠ è½½ARæ¨¡å‹ï¼Œè¯·ç¨å€™...<br><span id="loading-status"></span><div id="loading-progress">0%</div></div>
  </div>
  
  <button id="manual-start" class="manual-start-btn">æ‰‹åŠ¨å¼€å§‹AR</button>
  
  <div id="debug-info" class="debug-info">çŠ¶æ€: åˆå§‹åŒ–ä¸­...</div>

  <!-- a-frame scene -->
  <a-scene id="scene"
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true; antialias: true; precision: mediump;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3; maxDetectionRate: 60; canvasWidth: 1280; canvasHeight: 960;"
  >
    <!-- a-nft is the anchor that defines an Image Tracking entity -->
    <!-- on 'url' use the path to the Image Descriptors created before. -->
    <!-- è·¯å¾„ä¸å¸¦æ–‡ä»¶æ‹“å±•åï¼ã€æ³¨æ„ã€‘ä»¥ç½‘ç«™çš„åŸŸåä¸ºç›¸å¯¹è·¯å¾„ -->
    <a-nft
      type="nft"
      url="descriptors/py/py"
      smooth="true"
      smoothCount="5"
      smoothTolerance=".01"
      smoothThreshold="3"
    >
        <!-- as a child of the a-nft entity, you can define the content to show. here's a GLTF model entity -->
        <a-entity
            id="model-entity"
            gltf-model="model/py/scene.gltf"
            scale="0.8 0.8 0.8"
            position="0 0 0"
            rotation="-90 0 0"
        >
        </a-entity>
    </a-nft>
    <!-- static camera that moves according to the device movemenents -->
    <a-entity camera="fov: 75; near: 0.1; far: 1000"></a-entity>
  </a-scene>
</body>
<script>
  const debugInfo = document.getElementById('debug-info');
  const loadingStatus = document.getElementById('loading-status');
  const loadingProgress = document.getElementById('loading-progress');
  const manualStartBtn = document.getElementById('manual-start');
  const arjsLoader = document.querySelector('.arjs-loader');
  let descriptorsLoaded = false;
  let cameraReady = false;
  let loadingTimeout = null;
  
  // é¢„åŠ è½½NFTæè¿°æ–‡ä»¶æ£€æŸ¥
  function preloadDescriptors() {
    loadingStatus.innerHTML = "é¢„åŠ è½½å›¾åƒæè¿°æ–‡ä»¶...";
    
    const files = [
      'descriptors/py/py.fset',
      'descriptors/py/py.fset3',
      'descriptors/py/py.iset'
    ];
    
    let loadedCount = 0;
    
    files.forEach(file => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', file, true);
      xhr.onprogress = function(e) {
        if (e.lengthComputable) {
          const percentComplete = Math.round((e.loaded / e.total) * 100);
          loadingProgress.innerHTML = `åŠ è½½æè¿°æ–‡ä»¶: ${percentComplete}%`;
        }
      };
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          loadedCount++;
          loadingProgress.innerHTML = `å·²åŠ è½½ ${loadedCount}/${files.length} ä¸ªæè¿°æ–‡ä»¶`;
          
          if (loadedCount === files.length) {
            descriptorsLoaded = true;
            loadingStatus.innerHTML = "æ‰€æœ‰æè¿°æ–‡ä»¶å·²åŠ è½½ï¼Œç­‰å¾…ç›¸æœºåˆå§‹åŒ–...";
            checkAllReady();
          }
        } else {
          const errMsg = `æè¿°æ–‡ä»¶ ${file} åŠ è½½å¤±è´¥: ${xhr.status}`;
          console.error(errMsg);
          loadingStatus.innerHTML = `<span class="error-message">${errMsg}</span>`;
        }
      };
      xhr.onerror = function() {
        const errMsg = `æ— æ³•åŠ è½½æè¿°æ–‡ä»¶ ${file}. è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®ã€‚`;
        console.error(errMsg);
        loadingStatus.innerHTML = `<span class="error-message">${errMsg}</span>`;
        
        // æ˜¾ç¤ºæ‰‹åŠ¨å¼€å§‹æŒ‰é’®
        showManualStart();
      };
      xhr.send();
    });
  }
  
  // æ˜¾ç¤ºæ‰‹åŠ¨å¼€å§‹æŒ‰é’®
  function showManualStart() {
    manualStartBtn.style.display = 'block';
    manualStartBtn.addEventListener('click', function() {
      // å¼ºåˆ¶éšè—åŠ è½½ç•Œé¢å¹¶å°è¯•ç»§ç»­
      arjsLoader.style.display = 'none';
      manualStartBtn.style.display = 'none';
      debugInfo.innerHTML = "çŠ¶æ€: æ‰‹åŠ¨å¯åŠ¨AR";
    });
  }
  
  // æ£€æŸ¥æ˜¯å¦é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®
  if (window.location.protocol === 'file:') {
    const errorMsg = 'âš ï¸ é”™è¯¯ï¼šå¿…é¡»é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®æ­¤åº”ç”¨ï¼<br>è¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨å¦‚ python -m http.server 8000 æˆ– npx http-server';
    debugInfo.innerHTML = '<span class="error-message">' + errorMsg + '</span>';
    loadingStatus.innerHTML = '<span class="error-message">' + errorMsg + '</span>';
    console.error('å¿…é¡»é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®æ­¤åº”ç”¨ï¼Œä¸èƒ½ç›´æ¥æ‰“å¼€æœ¬åœ°æ–‡ä»¶ã€‚');
    console.error('å»ºè®®ä½¿ç”¨: python -m http.server 8000 å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨');
  } else {
    // è®¾ç½®åŠ è½½è¶…æ—¶
    loadingTimeout = setTimeout(function() {
      loadingStatus.innerHTML = "åŠ è½½æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜ã€‚<br>å°è¯•æ£€æŸ¥æè¿°æ–‡ä»¶æˆ–æ‰‹åŠ¨å¼€å§‹ã€‚";
      console.warn("ARåŠ è½½è¶…æ—¶");
      showManualStart();
    }, 15000); // 15ç§’è¶…æ—¶
    
    // å¼€å§‹é¢„åŠ è½½æè¿°æ–‡ä»¶
    preloadDescriptors();
  }
  
  // æ£€æŸ¥æ‰€æœ‰å¿…è¦ç»„ä»¶æ˜¯å¦å°±ç»ª
  function checkAllReady() {
    if (descriptorsLoaded && cameraReady) {
      loadingStatus.innerHTML = "æ‰€æœ‰ç»„ä»¶å·²å°±ç»ªï¼Œè¯·å¯¹å‡†å›¾åƒæ ‡è®°...";
      debugInfo.innerHTML = "çŠ¶æ€: å°±ç»ªï¼Œè¯·å¯¹å‡†å›¾åƒæ ‡è®°";
      
      // å¦‚æœ10ç§’å†…ä»æœªæ‰¾åˆ°æ ‡è®°ï¼Œæç¤ºç”¨æˆ·
      setTimeout(function() {
        // åªåœ¨è¿˜æœªæ‰¾åˆ°æ ‡è®°çš„æƒ…å†µä¸‹æç¤º
        if (arjsLoader.style.display !== 'none') {
          loadingStatus.innerHTML += '<br><span class="error-message">é•¿æ—¶é—´æœªè¯†åˆ«åˆ°å›¾åƒï¼Œè¯·ç¡®è®¤å›¾åƒæ¸…æ™°å¯è§</span>';
          showManualStart();
        }
      }, 10000);
    }
  }
  
  // åˆå§‹åŒ–æ—¶çš„äº‹ä»¶ç›‘å¬
  window.addEventListener('load', () => {
    if (window.location.protocol !== 'file:') {
      debugInfo.innerHTML = "çŠ¶æ€: é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…ARåˆå§‹åŒ–...";
      loadingStatus.innerHTML = "åˆå§‹åŒ–æ‘„åƒå¤´å’ŒARç¯å¢ƒ...";
      console.log('é¡µé¢å·²åŠ è½½');
      
      // æ£€æŸ¥WebGLæ”¯æŒ
      const canvas = document.createElement('canvas');
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (!gl) {
        const errMsg = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebGLï¼ŒARåŠŸèƒ½æ— æ³•ä½¿ç”¨";
        debugInfo.innerHTML = '<span class="error-message">' + errMsg + '</span>';
        loadingStatus.innerHTML = '<span class="error-message">' + errMsg + '</span>';
        console.error(errMsg);
      }
    }
  });
  
  // æ¨¡å‹åŠ è½½äº‹ä»¶
  document.addEventListener('model-loaded', (e) => {
    console.log('3Dæ¨¡å‹åŠ è½½æˆåŠŸ', e);
    debugInfo.innerHTML = "çŠ¶æ€: 3Dæ¨¡å‹åŠ è½½æˆåŠŸ";
    loadingStatus.innerHTML = "3Dæ¨¡å‹åŠ è½½æˆåŠŸï¼";
    
    // æ¸…é™¤è¶…æ—¶
    if (loadingTimeout) {
      clearTimeout(loadingTimeout);
    }
  });
  
  // æ¨¡å‹åŠ è½½é”™è¯¯äº‹ä»¶
  document.querySelector('#model-entity').addEventListener('model-error', (e) => {
    console.error('3Dæ¨¡å‹åŠ è½½å¤±è´¥', e);
    debugInfo.innerHTML = "çŠ¶æ€: 3Dæ¨¡å‹åŠ è½½å¤±è´¥";
    loadingStatus.innerHTML = "3Dæ¨¡å‹åŠ è½½å¤±è´¥ï¼";
    showManualStart();
  });

  // NFTæ ‡è®°äº‹ä»¶
  document.querySelector('a-nft').addEventListener('markerFound', () => {
    console.log('ğŸ¯ è¯†åˆ«åˆ°å›¾åƒæ ‡è®°!');
    debugInfo.innerHTML = "çŠ¶æ€: è¯†åˆ«åˆ°å›¾åƒæ ‡è®° âœ“";
    // éšè—åŠ è½½ç•Œé¢
    arjsLoader.style.display = 'none';
    // éšè—æ‰‹åŠ¨å¼€å§‹æŒ‰é’®
    manualStartBtn.style.display = 'none';
    
    // æ¸…é™¤è¶…æ—¶
    if (loadingTimeout) {
      clearTimeout(loadingTimeout);
    }
  });
  
  document.querySelector('a-nft').addEventListener('markerLost', () => {
    console.log('ğŸ“­ å›¾åƒæ ‡è®°ä¸¢å¤±!');
    debugInfo.innerHTML = "çŠ¶æ€: å›¾åƒæ ‡è®°ä¸¢å¤± âœ—";
  });
  
  // åœºæ™¯åŠ è½½äº‹ä»¶
  document.querySelector('a-scene').addEventListener('loaded', function() {
    console.log('A-Frameåœºæ™¯å·²åŠ è½½');
    debugInfo.innerHTML = "çŠ¶æ€: A-Frameåœºæ™¯å·²åŠ è½½";
    loadingStatus.innerHTML = "åœºæ™¯å·²åŠ è½½ï¼Œç­‰å¾…è¯†åˆ«å›¾åƒ...";
  });
  
  // æ·»åŠ å¯¹æè¿°æ–‡ä»¶åŠ è½½äº‹ä»¶çš„ä¸“é—¨å¤„ç†
  document.querySelector('a-nft').addEventListener('loaded', function() {
    console.log('NFTç»„ä»¶å·²åŠ è½½');
    debugInfo.innerHTML = "çŠ¶æ€: NFTç»„ä»¶å·²åŠ è½½";
    loadingStatus.innerHTML = "NFTç»„ä»¶å·²åŠ è½½ï¼Œå°è¯•è¯†åˆ«å›¾åƒ...";
  });
  
  // ARåˆå§‹åŒ–é”™è¯¯æ•è·
  window.addEventListener('artoolkit-camera-error', function(error) {
    console.error('AR Toolkitç›¸æœºé”™è¯¯:', error);
    debugInfo.innerHTML = "AR Toolkitç›¸æœºé”™è¯¯: " + error;
    loadingStatus.innerHTML = "ç›¸æœºåˆå§‹åŒ–å¤±è´¥ï¼";
    showManualStart();
  });
  
  window.addEventListener('artoolkit-nft-loaded', function() {
    console.log('NFTæ ‡è®°æ•°æ®åŠ è½½å®Œæˆ');
    debugInfo.innerHTML = "çŠ¶æ€: NFTæ ‡è®°æ•°æ®å°±ç»ªï¼Œè¯·å¯¹å‡†å›¾åƒ";
    loadingStatus.innerHTML = "æ ‡è®°æ•°æ®å°±ç»ªï¼Œè¯·å¯¹å‡†å›¾åƒ...";
    descriptorsLoaded = true;
    checkAllReady();
  });
  
  // æ‘„åƒå¤´æƒé™äº‹ä»¶
  navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
    .then(function(stream) {
      debugInfo.innerHTML = "çŠ¶æ€: æ‘„åƒå¤´å·²å¯ç”¨";
      loadingStatus.innerHTML = "æ‘„åƒå¤´å·²å¯ç”¨ï¼Œå‡†å¤‡è¯†åˆ«å›¾åƒ...";
      console.log('æ‘„åƒå¤´æƒé™è·å–æˆåŠŸ');
      cameraReady = true;
      checkAllReady();
      
      // æ£€æŸ¥æ‘„åƒå¤´å®é™…æ˜¯å¦å·¥ä½œ
      const track = stream.getVideoTracks()[0];
      if (!track || !track.enabled) {
        console.warn('æ‘„åƒå¤´è½¨é“æœªå¯ç”¨');
        loadingStatus.innerHTML += '<br>è­¦å‘Š: æ‘„åƒå¤´å¯èƒ½æœªæ­£å¸¸å·¥ä½œ';
      }
    })
    .catch(function(err) {
      console.error('æ‘„åƒå¤´è®¿é—®é”™è¯¯:', err);
      debugInfo.innerHTML = "çŠ¶æ€: æ‘„åƒå¤´è®¿é—®é”™è¯¯ - " + err.message;
      loadingStatus.innerHTML = "æ‘„åƒå¤´è®¿é—®é”™è¯¯ï¼";
      showManualStart();
    });
</script>
</html>
